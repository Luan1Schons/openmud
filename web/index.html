<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMud - Cliente Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        #header {
            background: #1a1a1a;
            padding: 10px;
            border-bottom: 2px solid #00ff00;
            text-align: center;
        }
        
        #header h1 {
            color: #00ff00;
            font-size: 24px;
        }
        
        #status {
            padding: 5px 10px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            font-size: 12px;
        }
        
        #status.connected {
            color: #00ff00;
        }
        
        #status.disconnected {
            color: #ff0000;
        }
        
        #status.connecting {
            color: #ffff00;
        }
        
        #terminal {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #000;
            font-size: 14px;
            line-height: 1.4;
        }
        
        #terminal::-webkit-scrollbar {
            width: 10px;
        }
        
        #terminal::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        #terminal::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 5px;
        }
        
        #input-container {
            background: #1a1a1a;
            padding: 10px;
            border-top: 2px solid #00ff00;
            display: flex;
            align-items: center;
        }
        
        #prompt {
            color: #00ff00;
            margin-right: 10px;
            font-weight: bold;
        }
        
        #command-input {
            flex: 1;
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }
        
        #command-input:focus {
            border-color: #00ffff;
            box-shadow: 0 0 5px #00ffff;
        }
        
        #send-btn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 8px 20px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        #send-btn:hover {
            background: #00ffff;
        }
        
        #send-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Cores ANSI b치sicas */
        .ansi-reset { color: #00ff00; }
        .ansi-red { color: #ff0000; }
        .ansi-green { color: #00ff00; }
        .ansi-yellow { color: #ffff00; }
        .ansi-blue { color: #0000ff; }
        .ansi-magenta { color: #ff00ff; }
        .ansi-cyan { color: #00ffff; }
        .ansi-white { color: #ffffff; }
        .ansi-bright-red { color: #ff5555; }
        .ansi-bright-green { color: #55ff55; }
        .ansi-bright-yellow { color: #ffff55; }
        .ansi-bright-blue { color: #5555ff; }
        .ansi-bright-magenta { color: #ff55ff; }
        .ansi-bright-cyan { color: #55ffff; }
        .ansi-bright-white { color: #ffffff; }
        .ansi-black { color: #000000; }
        .ansi-bright-black { color: #555555; }
        .ansi-bold { font-weight: bold; }
    </style>
</head>
<body>
    <div id="header">
        <h1>游꿡 OpenMud - Cliente Web</h1>
    </div>
    
    <div id="status" class="disconnected">
        游댮 Desconectado
    </div>
    
    <div id="terminal"></div>
    
    <div id="input-container">
        <span id="prompt">></span>
        <input type="text" id="command-input" placeholder="Digite seu comando..." disabled>
        <button id="send-btn" disabled>Enviar</button>
    </div>
    
    <script>
        class MUDClient {
            constructor() {
                this.ws = null;
                this.connected = false;
                // Detecta porta WebSocket
                // Por padr칚o, WebSocket est치 na porta 8080
                this.wsHost = window.location.hostname;
                this.wsPort = '8080'; // Porta padr칚o do WebSocket
                this.wsUrl = `ws://${this.wsHost}:${this.wsPort}`;
                
                // Se estiver em produ칞칚o com porta customizada, pode ser detectada via meta tag
                const wsMeta = document.querySelector('meta[name="websocket-port"]');
                if (wsMeta) {
                    this.wsPort = wsMeta.getAttribute('content');
                    this.wsUrl = `ws://${this.wsHost}:${this.wsPort}`;
                }
                
                this.terminal = document.getElementById('terminal');
                this.status = document.getElementById('status');
                this.input = document.getElementById('command-input');
                this.sendBtn = document.getElementById('send-btn');
                this.prompt = document.getElementById('prompt');
                
                this.setupEventListeners();
                this.connect();
            }
            
            setupEventListeners() {
                this.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendCommand();
                    }
                });
                
                this.sendBtn.addEventListener('click', () => {
                    this.sendCommand();
                });
            }
            
            connect() {
                this.updateStatus('connecting', '游리 Conectando...');
                
                try {
                    this.ws = new WebSocket(this.wsUrl);
                    
                    this.ws.onopen = () => {
                        this.connected = true;
                        this.updateStatus('connected', '游릭 Conectado');
                        this.input.disabled = false;
                        this.sendBtn.disabled = false;
                        this.input.focus();
                        this.addLine('Conectado ao servidor MUD!', 'ansi-green');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'mud_output') {
                            this.addMudOutput(data.data);
                        } else if (data.type === 'error') {
                            this.addLine(`Erro: ${data.data}`, 'ansi-red');
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.addLine('Erro na conex칚o WebSocket', 'ansi-red');
                    };
                    
                    this.ws.onclose = () => {
                        this.connected = false;
                        this.updateStatus('disconnected', '游댮 Desconectado');
                        this.input.disabled = true;
                        this.sendBtn.disabled = true;
                        this.addLine('Conex칚o fechada. Tentando reconectar em 3 segundos...', 'ansi-yellow');
                        setTimeout(() => this.connect(), 3000);
                    };
                } catch (error) {
                    console.error('Erro ao conectar:', error);
                    this.updateStatus('disconnected', '游댮 Erro na conex칚o');
                    setTimeout(() => this.connect(), 3000);
                }
            }
            
            updateStatus(status, text) {
                this.status.className = status;
                this.status.textContent = text;
            }
            
            addLine(text, className = '') {
                const line = document.createElement('div');
                line.className = `line ${className}`;
                line.textContent = text;
                this.terminal.appendChild(line);
                this.terminal.scrollTop = this.terminal.scrollHeight;
            }
            
            addMudOutput(text) {
                // Remove \r mas preserva \n
                let normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '');
                
                // Divide em linhas preservando quebras de linha
                const lines = normalized.split('\n');
                
                // Processa cada linha separadamente para preservar formata칞칚o
                lines.forEach((line, index) => {
                    // Processa c칩digos ANSI antes de verificar se est치 vazio
                    const processed = this.processAnsi(line);
                    
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'line';
                    
                    // Se a linha est치 vazia (ap칩s processar ANSI), mostra espa칞o n칚o-quebr치vel
                    // Mas preserva todas as linhas, incluindo vazias no meio
                    if (processed.trim() === '' && processed === '') {
                        lineDiv.innerHTML = '&nbsp;';
                    } else {
                        lineDiv.innerHTML = processed;
                    }
                    
                    this.terminal.appendChild(lineDiv);
                });
                
                this.terminal.scrollTop = this.terminal.scrollHeight;
            }
            
            processAnsi(text) {
                // Processa c칩digos ANSI de forma mais robusta
                let result = text;
                let openSpans = [];
                
                // Processa c칩digos ANSI
                result = result.replace(/\x1b\[([0-9;]+)m/g, (match, codes) => {
                    const codeList = codes.split(';');
                    let html = '';
                    
                    for (const code of codeList) {
                        const num = parseInt(code);
                        
                        if (num === 0) {
                            // Reset - fecha todas as spans abertas
                            html = '</span>'.repeat(openSpans.length);
                            openSpans = [];
                        } else if (num === 1) {
                            html += '<span class="ansi-bold">';
                            openSpans.push('bold');
                        } else if (num >= 30 && num <= 37) {
                            // Cores normais
                            const colors = ['black', 'red', 'green', 'yellow', 'blue', 'magenta', 'cyan', 'white'];
                            html += `<span class="ansi-${colors[num - 30]}">`;
                            openSpans.push('color');
                        } else if (num >= 90 && num <= 97) {
                            // Cores brilhantes
                            const colors = ['bright-black', 'bright-red', 'bright-green', 'bright-yellow', 
                                         'bright-blue', 'bright-magenta', 'bright-cyan', 'bright-white'];
                            html += `<span class="ansi-${colors[num - 90]}">`;
                            openSpans.push('color');
                        }
                    }
                    
                    return html;
                });
                
                // Remove c칩digos de controle n칚o processados (mas preserva quebras de linha)
                result = result.replace(/\x1b\[[0-9;]*[^m]/g, '');
                result = result.replace(/\x1b\[K/g, ''); // Clear line
                result = result.replace(/\x1b\[H/g, ''); // Home
                result = result.replace(/\r/g, ''); // Remove \r mas preserva \n
                
                return result;
            }
            
            sendCommand() {
                const command = this.input.value.trim();
                if (!command || !this.connected) return;
                
                // Mostra comando no terminal
                this.addLine(`> ${command}`, 'ansi-cyan');
                
                // Envia para o servidor
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'mud_input',
                        data: command
                    }));
                }
                
                // Limpa input
                this.input.value = '';
            }
        }
        
        // Inicia cliente quando a p치gina carregar
        window.addEventListener('DOMContentLoaded', () => {
            new MUDClient();
        });
    </script>
</body>
</html>

